# SysY编译器项目分析报告

## 1. 项目概述

该项目是一个SysY编程语言的编译器实现，采用C++开发，支持词法分析、语法分析、语义分析等编译器前端功能。SysY是一个小型的类C语言，用于编译原理课程实验，具有简洁的语法和完整的类型系统。

## 2. 项目结构

```
SysY/
├── CMakeLists.txt          # 项目构建配置文件
├── README.md               # 项目说明文档
├── include/                # 头文件目录
│   ├── Lexer.h             # 词法分析器接口
│   ├── Parser.h            # 语法分析器接口
│   ├── ast.h               # 抽象语法树定义
│   ├── ast_visitor.h       # AST访问者接口
│   ├── ir.h                # 中间代码表示
│   ├── print_visitor.h     # AST打印器接口
│   ├── semantic_analyzer.h # 语义分析器接口
│   ├── symbol_table.h      # 符号表接口
│   └── token.h             # Token定义
├── src/                    # 源文件目录
│   ├── ast.cpp             # AST实现
│   ├── lexer.cpp           # 词法分析器实现
│   ├── main.cpp            # 编译器入口
│   ├── parser.cpp          # 语法分析器实现
│   ├── print_visitor.cpp   # AST打印器实现
│   ├── scanner.l           # Flex词法分析器定义
│   ├── semantic_analyzer.cpp # 语义分析器实现
│   └── symbol_table.cpp    # 符号表实现
├── tests/                  # 测试文件目录
│   ├── work1_test/         # 第一阶段测试用例
│   ├── work2_test/         # 第二阶段测试用例
│   ├── work3_test/         # 第三阶段测试用例
│   └── work4_test/         # 第四阶段测试用例
├── tools/                  # 工具目录
│   ├── README.md           # 工具说明
│   └── test_runner.ps1     # 测试脚本
├── .gitignore              # Git忽略配置
├── 项目整体.docx          # 项目整体文档（旧版本）
└── 项目整体.txt            # 项目整体文档（新版本）
```

## 3. 核心组件分析

### 3.1 词法分析器 (Lexer)

词法分析器负责将源代码转换为Token流。项目实现了两种词法分析器：

1. **Flex实现** (src/scanner.l)：
   - 使用Flex工具生成词法分析器
   - 定义了各种词法规则，如整数常量、浮点数常量、标识符、关键字等
   - 支持注释处理（单行和多行注释）
   - 返回Token类型和对应的值

2. **手写实现** (src/lexer.cpp)：
   - 提供getToken()方法获取下一个Token
   - 支持peek()方法预览下一个Token
   - 实现了字符处理和Token解析的核心逻辑
   - 维护行号和列号信息，用于错误报告

### 3.2 语法分析器 (Parser)

语法分析器负责将Token流转换为抽象语法树(AST)，采用递归下降解析技术。主要功能包括：

- 解析程序结构（编译单元、函数定义等）
- 解析声明语句（变量声明、常量声明等）
- 解析表达式（二元表达式、一元表达式、函数调用等）
- 解析语句（if-else、while、return等）
- 错误检测和报告

核心方法包括：
- parseCompUnit()：解析编译单元
- parseFuncDef()：解析函数定义
- parseVarDef()：解析变量定义
- parseExpression()：解析表达式
- parseStatement()：解析语句

### 3.3 抽象语法树 (AST)

AST是编译器前端的核心数据结构，用于表示程序的语法结构。项目采用面向对象设计，定义了多种AST节点类型：

- 程序结构节点：CompUnit、FuncDef、FuncFParam
- 声明节点：VarDecl、VarDef
- 表达式节点：BinaryExpr、UnaryExpr、IndexExpr、CallExpr、NumberExpr、VariableExpr
- 语句节点：IfStmt、WhileStmt、ReturnStmt、Block、ExprStmt、DeclStmt

所有AST节点都实现了accept()方法，支持访问者模式，便于后续的语义分析、代码生成等阶段处理。

### 3.4 符号表 (Symbol Table)

符号表用于管理变量、函数、常量等符号的存储和查找，支持作用域管理：

- enterScope()：进入新作用域
- exitScope()：退出当前作用域
- insert()：向当前作用域插入符号
- lookup()：从内向外查找符号
- lookupCurrentScope()：在当前作用域查找符号

符号表条目(SymbolEntry)包含符号的类型、作用域、属性等信息，支持变量、函数等不同类型的符号。

### 3.5 语义分析器 (Semantic Analyzer)

语义分析器继承自ASTVisitor，负责进行语义验证：

- 类型检查：确保操作符的操作数类型匹配
- 作用域分析：检查变量和函数的可见性
- 符号验证：检查符号的重复定义、未定义使用等
- 返回值检查：确保函数返回值类型匹配
- 错误报告：生成详细的错误信息，包括错误类型、行号等

语义分析器实现了多种错误检测，如：
- 重定义的函数或变量
- 未定义的函数或变量
- 类型不匹配的表达式
- 无效的数组访问
- void函数返回值错误等

### 3.6 AST打印器 (Print Visitor)

AST打印器用于打印AST结构，便于调试和可视化：

- 采用缩进格式显示AST层次结构
- 显示节点类型、操作符、值等信息
- 支持所有AST节点类型的打印

## 4. 项目特点

### 4.1 设计模式应用

- **访问者模式**：用于AST的遍历和处理，便于扩展新的分析功能
- **单例模式**：用于符号表等全局组件的管理
- **工厂模式**：用于创建各种AST节点

### 4.2 错误处理机制

- 详细的错误报告，包括错误类型、行号、列号
- 支持多种错误类型，如语法错误、语义错误等
- 提供友好的错误信息，便于调试和修复

### 4.3 代码质量保证

- 模块化设计，代码结构清晰
- 详细的注释，便于理解和维护
- 丰富的测试用例，覆盖各种语法结构和错误场景
- 自动化测试脚本，方便验证编译器功能

## 5. 编译流程

1. **词法分析**：将源代码转换为Token流
2. **语法分析**：将Token流转换为抽象语法树(AST)
3. **语义分析**：对AST进行类型检查、作用域分析等语义验证
4. **中间代码生成**：将AST转换为中间代码(IR)（待实现）
5. **目标代码生成**：将中间代码转换为目标机器代码（待实现）

## 6. 测试

项目提供了丰富的测试用例，按功能模块组织：

- **work1_test**：基本功能测试，如变量声明、函数定义等
- **work2_test**：语法结构测试，包括正确和错误的语法示例
- **work3_test**：语法分析测试，覆盖各种语法结构
- **work4_test**：语义分析测试，覆盖各种语义错误场景

测试脚本tools/test_runner.ps1支持自动化测试，方便验证编译器功能。

## 7. 总结与展望

### 7.1 已实现功能

- 完整的词法分析器
- 完整的语法分析器
- 完整的AST实现
- 完整的符号表实现
- 完整的语义分析器
- 丰富的测试用例

### 7.2 待实现功能

- 中间代码生成
- 目标代码生成
- 代码优化
- 更丰富的错误检测
- 性能优化

### 7.3 技术亮点

- 采用现代C++特性，如智能指针、Lambda表达式等
- 设计模式的合理应用，提高代码的可维护性和扩展性
- 模块化设计，各组件之间低耦合
- 详细的文档和注释，便于理解和使用

## 8. 使用说明

### 8.1 构建项目

```bash
mkdir build
cd build
cmake ..
make
```

### 8.2 运行编译器

```bash
./sysy_compiler input.sy output.ir
```

### 8.3 运行测试

```bash
powershell -File tools/test_runner.ps1
```

## 9. 参考资料

- SysY语言定义文档
- 编译原理教材
- Flex/Bison用户手册
- C++标准库文档

---

以上是对SysY编译器项目的全面分析，涵盖了项目的结构、功能、设计和实现细节。该项目实现了一个完整的编译器前端，为后续的中间代码生成和目标代码生成奠定了基础。